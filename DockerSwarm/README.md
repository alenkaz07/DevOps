# Проект: Оркестрация микросервисов с использованием Docker Swarm и Vagrant

## Описание
Данный проект демонстрирует принципы оркестрации контейнеров с использованием *Docker Swarm* и развертывание многоконтейнерного веб-сервиса. Он состоит из нескольких микросервисов, которые взаимодействуют между собой. Для управления виртуальными машинами используется *Vagrant*.

## Структура проекта
- **Dockerfiles** для каждого микросервиса.
- **docker-compose.yml** — основной файл для описания взаимодействия сервисов и их конфигурации.
- **Vagrantfile** — файл для настройки виртуальных машин.
- **nginx.conf** — конфигурация прокси-сервера для доступа к микросервисам через Nginx.
- **Shell-скрипты** в директории [scripts](./scripts/) для автоматизации установки Docker и инициализации Docker Swarm.
- **Postman** — тесты для проверки корректной работы сервисов.
- **Portainer** — инструмент для визуализации распределения задач в кластере Docker Swarm.

## Сервисы
Проект состоит из следующих микросервисов:
1. **Session Service** — отвечает за управление пользовательскими сессиями.
2. **Hotel Service** — сервис управления отелями.
3. **Payment Service** — сервис оплаты.
4. **Loyalty Service** — управление программой лояльности.
5. **Report Service** — статистика.
6. **Booking Service** — сервис бронирования.
7. **Gateway Service** — основной шлюз для взаимодействия с микросервисами.
8. **RabbitMQ** — брокер сообщений.
9. **Database** — база данных *postgres*.

## Начало работы
### Предварительные требования
Для работы с проектом требуются следующие инструменты:
- **Vagrant** — для управления виртуальными машинами.
- **VirtualBox** — для создания виртуальных машин.
- **Docker** и **Docker Compose** — для контейнеризации сервисов.
- **Maven** — для сборки Java-проектов.
- **VPN** *(опционально)* — для доступа к Vagrant Cloud.

### Шаг 1: Установка и настройка Vagrant
1. Установите *Vagrant* и *VirtualBox*.
2. В корне проекта создайте файл `Vagrantfile` и настройте виртуальные машины:

``` bash
vagrant init
```

3. Для создания кластера *Docker Swarm* используется `Vagrantfile`, который поднимает три виртуальные машины и устанавливает *Docker*.

### Шаг 2: Запуск виртуальных машин и установка Docker
1. Запустите виртуальные машины:

```bash
vagrant up
```

### Шаг 2: Сборка и развертывание микросервисов
1. Соберите образы всех микросервисов:

```bash
docker-compose up --build -d
```

2. Загрузите образы на Docker Hub:

```bash
docker build -t <dockerhub_логин>/<имя_сервиса>:latest .
docker push <dockerhub_логин>/<имя_сервиса>:latest
```

3. Используйте `docker-compose.yml` для использования образов из *Docker Hub* и разверните стек:

```bash
sudo docker stack deploy -c docker-compose.yml webservice
```

### Шаг 3: Настройка прокси-сервера Nginx
1. Обновите файл конфигурации `nginx.conf`.
2. Скопируйте конфигурацию на `manager01`:

```bash
vagrant scp ./nginx.conf manager01:/home/vagrant/src/nginx.conf
```

3. Перезапустите стек сервисов, чтобы применить изменения.

### Шаг 4: Тестирование
1. Для тестирования работы микросервисов используйте Postman. Импортируйте готовые тесты и проверьте корректность работы всех сервисов.
2. Убедитесь, что все тесты проходят успешно.

### Шаг 5: Установка Portainer
1. Скачайте конфигурацию Portainer:

``` bash
curl -L https://downloads.portainer.io/portainer-agent-stack.yml -o portainer-agent-stack.yml
```

2. Разверните Portainer:

``` bash
docker stack deploy -c portainer-agent-stack.yml portainer
```

3. Подключитесь к интерфейсу Portainer через браузер по адресу `http://localhost:9000` и настройте учетную запись.

### Шаг 6: Просмотр состояния кластера
1. В командной строке на мастер-узле выполните команды для проверки состояния узлов и задач:

```bash
sudo docker node ls
sudo docker service ls
sudo docker stack ps webservice
```

2. В Portainer вы можете визуально оценить распределение контейнеров и состояние сервисов.

## Полезные команды
- Остановка и удаление виртуальных машин:

```bash
vagrant halt
vagrant destroy
```

- Перезапуск стеков Docker:

```bash
sudo docker stack rm <название_стека>
sudo docker stack deploy -c docker-compose.yml <название_стека>
```

- Подключение к виртуальным машинам:

```bash
vagrant ssh manager01
vagrant ssh worker01
```

## Заключение
Данный проект демонстрирует цепочку оркестрации микросервисов, начиная с их сборки и развертывания на виртуальных машинах и заканчивая визуализацией состояния кластера с помощью Portainer.

>Проект создан для образовательных целей и практики оркестрации контейнеров на основе микросервисной архитектуры.
